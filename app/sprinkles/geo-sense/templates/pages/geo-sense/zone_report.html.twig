{% extends "pages/layouts/layout-dashboard.html.twig" %}

{% block page %}
    {% set page = page | merge({
        "title"       : "Zones Report",
        "description" : "Zones Report page"
    }) %}
    {{ parent() }}
{% endblock %}

{% block content %}
<div class="row">
    <div class="row text-center" style="display: none" id="pdf_title">
        <img src="{{site.uri.public}}/images/WiFi-Logo-Image-Blue.png" height="50px" width="50px" style="margin-top: 5px"/>
        <u><h1 class="bold">INTELLI-SENSE</h1></u>
    </div>

    <div class="col-lg-12" align="center">
        <h3 style="color:#001E4C">{{current_user.venue_name}}</h3>
        <h4 style="color:#e25826">{{page.title}}</h4>
    </div>
</div>
{% if checkAccess('print_and_export') %}
<div class="row noprint">
    <div class="col-xs-12">
        <i class="fa fa-print fa-lg fa-fw clickable pull-right" aria-hidden="true" onclick="genPDF();" data-toggle="tooltip" data-placement="top" title="Print this page."></i>
        <i class="fas fa-cloud-download-alt fa-lg fa-fw clickable pull-right" id="csv_button" aria-hidden="true" data-toggle="tooltip" data-placement="top" title="Download report data in CSV format"></i>
    </div>
</div>
{% endif %}
{# ************************ SECTION 1 *************************** #}
<hr>
<div  class="row zone_report_section_2" style="display:none;">
    <div class="col-xs-6">
        <form class="form-horizontal">
            <div class="form-group">
                <label for="name" class="col-sm-2 control-label"><span class="badge badge-primary" style="font-size: 120%;">Zone 3</span></label>
                <div class="col-sm-10">
                    <div class="input-group">
                        <select class='form-control' id="section_1_select_zone_id" name="section_1_select_zone_id">
                            <option value="">Please select a Zone</option>
                            {% if checkAccess('uri_site_admin') %}
                                {% for zone in current_user.primaryVenue.zones %}
                                    {% if (zone.tracking_zone == 1) %}
                                        <option value="{{zone.id}}">{{zone.name|e }}</option>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {% for zone in current_user.getZones %}
                                    {% if (zone.venue_id == current_user.primaryVenue.id and zone.tracking_zone == 1) %}
                                        <option value="{{zone.id}}">{{zone.name|e }}</option>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="col-xs-6 zone_report_section_1" style="display:none;">
        <i id="section_1_page_daterange" class="fa fa-calendar fa-lg fa-fw pull-right clickable" data-toggle="tooltip" data-placement="top"
           title="After selecting a zone, a different date range may be selected."></i>
        <span id="section_1_page_daterange_selected_large" class="visible-sm-inline visible-md-inline visible-lg-inline pull-right">&nbsp;</span>
        <span id="section_1_page_daterange_selected_small"
            class="visible-xs-inline pull-right">&nbsp;</span>
    </div>
</div>
<div class="row zone_report_section_1" style="display:none; PAGE-BREAK-BEFORE: always">
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_1_donut_5"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per year </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_1_donut_6"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per month </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_1_donut_7"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per week </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_1_donut_8"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per day </div>
            </div>
        </a>
    </div>
</div>
<div class="row zone_report_section_1" style="display:none;">
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_1_donut_1"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Total visitors this period </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_1_donut_2"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Busiest time of day </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_1_donut_3"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average dwell time </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_1_donut_4"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per day </div>
            </div>
        </a>
    </div>
</div>
<br class="row zone_report_section_1" style="display:none;">
<!-- /.row -->
<div class="row zone_report_section_1" style="display:none;">
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Time of Day average</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_1_chart_1_1" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Total Visitors - New Vs Repeat</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_1_chart_1_2" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
</div>
<div class="row zone_report_section_1" style="display:none;">
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Number of Visitors - New Vs Repeat</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_1_chart_2_1" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Dwell time Analysis</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_1_chart_2_2" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
</div>
<!-- /.row -->
<div class="visible-print-block pagebreak"></div>
<hr class="row zone_report_section_1" style="display:none;">
{# ************************ SECTION 2 *************************** #}
<div class="row zone_report_section_3" style="display:none; PAGE-BREAK-BEFORE: always">
    <div class="col-xs-6">
        <form class="form-horizontal">
            <div class="form-group">
                <label for="name" class="col-sm-2 control-label"><span class="badge badge-primary" style="font-size: 120%;">Zone 2</span></label>
                <div class="col-sm-10">
                    <div class="input-group">
                        <select class='form-control' id="section_2_select_zone_id" name="section_2_select_zone_id">
                            <option value="">Please select a Zone</option>
                            {% if checkAccess('uri_site_admin') %}
                                {% for zone in current_user.primaryVenue.zones %}
                                    {% if (zone.tracking_zone == 1) %}
                                        <option value="{{zone.id}}">{{zone.name|e }}</option>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {% for zone in current_user.getZones %}
                                    {% if (zone.venue_id == current_user.primaryVenue.id and zone.tracking_zone == 1) %}
                                        <option value="{{zone.id}}">{{zone.name|e }}</option>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="col-xs-6 zone_report_section_2" style="display:none;">
        <i id="section_2_page_daterange" class="fa fa-calendar fa-lg fa-fw pull-right clickable" data-toggle="tooltip" data-placement="top"
           title="After selecting a zone, a different date range may be selected."></i>
        <span id="section_2_page_daterange_selected_large" class="visible-sm-inline visible-md-inline visible-lg-inline pull-right">&nbsp;</span>
        <span id="section_2_page_daterange_selected_small"
            class="visible-xs-inline pull-right">&nbsp;</span>
    </div>
</div>
<div class="row zone_report_section_2" style="display:none;">
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_2_donut_5"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per year </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_2_donut_6"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per month </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_2_donut_7"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per week </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_2_donut_8"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per day </div>
            </div>
        </a>
    </div>
</div>
<div class="row zone_report_section_2" style="display:none;">
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_2_donut_1"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Total visitors this period </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_2_donut_2"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Busiest time of day </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_2_donut_3"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average dwell time </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_2_donut_4"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per day </div>
            </div>
        </a>
    </div>
</div>
<br class="row zone_report_section_2" style="display:none;">
<!-- /.row -->
<div class="row zone_report_section_2" style="display:none;">
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Time of Day average</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_2_chart_1_1" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Total Visitors - New Vs Repeat</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_2_chart_1_2" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
</div>
<div class="row zone_report_section_2" style="display:none;">
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Number of Visitors - New Vs Repeat</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_2_chart_2_1" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Dwell time Analysis</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_2_chart_2_2" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
</div>
<!-- /.row -->
<div class="visible-print-block pagebreak"></div>
<hr class="row zone_report_section_2" style="display:none;">
{# ************************ SECTION 3 *************************** #}
<div class="row" style="PAGE-BREAK-BEFORE: always">
    <div class="col-xs-6">
        <form class="form-horizontal">
            <div class="form-group">
                <label for="name" class="col-sm-2 control-label"><span class="badge badge-primary" style="font-size: 120%;">Zone 1</span></label>
                <div class="col-sm-10">
                    <div class="input-group">
                        <select class='form-control' id="section_3_select_zone_id" name="section_3_select_zone_id">
                            <option value="">Please select a Zone</option>
                            {% if checkAccess('uri_site_admin') %}
                                {% for zone in current_user.primaryVenue.zones %}
                                    {% if (zone.tracking_zone == 1) %}
                                        <option value="{{zone.id}}">{{zone.name|e }}</option>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {% for zone in current_user.getZones %}
                                    {% if (zone.venue_id == current_user.primaryVenue.id and zone.tracking_zone == 1) %}
                                        <option value="{{zone.id}}">{{zone.name|e }}</option>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="col-xs-6 zone_report_section_3" style="display:none;">
        <i id="section_3_page_daterange" class="fa fa-calendar fa-lg fa-fw pull-right clickable" data-toggle="tooltip" data-placement="top"
           title="After selecting a zone, a different date range may be selected."></i>
        <span id="section_3_page_daterange_selected_large" class="visible-sm-inline visible-md-inline visible-lg-inline pull-right">&nbsp;</span>
        <span id="section_3_page_daterange_selected_small"
            class="visible-xs-inline pull-right">&nbsp;</span>
    </div>
</div>
<div class="row zone_report_section_3" style="display:none;">
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_3_donut_5"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per year </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_3_donut_6"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per month </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_3_donut_7"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per week </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 blue-soft" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_3_donut_8"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per day </div>
            </div>
        </a>
    </div>
</div>
<div class="row zone_report_section_3" style="display:none;">
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_3_donut_1"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Total visitors this period </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_3_donut_2"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Busiest time of day </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_3_donut_3"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average dwell time </div>
            </div>
        </a>
    </div>
    <div class="col-lg-3 col-md-3 col-sm-6 col-xs-12">
        <a id="donut_container_1" class="dashboard-stat dashboard-stat-v2 yellow-gold" href="#">
            <div class="visual">
                <i class="fa fa-users"></i>
            </div>
            <div class="details">
                <div class="number bold">
                    <span id="section_3_donut_4"><i class="fa fa-circle-o-notch fa-spin" style="font-size: 70%;"></i></span>
                </div>
                <div class="desc"> Average visitors per day </div>
            </div>
        </a>
    </div>
</div>
<br class="row zone_report_section_3" style="display:none;">
<!-- /.row -->
<div class="row zone_report_section_3" style="display:none;">
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Time of Day average</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_3_chart_1_1" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Total Visitors - New Vs Repeat</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_3_chart_1_2" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
</div>
<div class="visible-print-block pagebreak"></div>
<div class="row zone_report_section_3" style="display:none;">
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Number of Visitors - New Vs Repeat</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_3_chart_2_1" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
    <div class="col-lg-6 col-xs-12 col-sm-12">
        <div id="chart_container_2_1" class="portlet light bordered">
            <div class="portlet-title">
                <div class="caption ">
                    <span class="caption-subject font-blue-sharp bold">Dwell time Analysis</span>
                    <span class="caption-helper"></span>
                </div>
                <div class="tools">
                    <i class="fa fa-question-circle info-icon"></i>
                    <a href="" class="collapse"> </a>
                    <a href="" class="fullscreen"> </a>
                </div>
            </div>
            <div class="portlet-body">
                <div id="section_3_chart_2_2" style="width: 100%; height: 200px; margin: 0 auto"></div>
            </div>
        </div>
    </div>
</div>

<div class="row text-center" style="display: none" id="pdf_url">
    website address: <a>www.elephantwifi.co.uk</a>
</div>

<!-- /.row -->
{% endblock %}

{% block page_scripts %}
<script type="text/javascript">
function genPDF() {
    var pdf_title = document.getElementById("pdf_title");
    if (pdf_title.style.display === "none") {
        pdf_title.style.display = "block";
    }

    var pdf_url = document.getElementById("pdf_url");
    if (pdf_url.style.display === "none") {
        pdf_url.style.display = "block";
    }

    var element = document.getElementsByClassName("page-content")[0];
    var opt = {
        margin:       1,
        filename:     'zone_report.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 1 },
        jsPDF:        { unit: 'pt', format: [1280, 720], orientation: 'l' }
    };

    html2pdf().set(opt).from(element).save();

    // Hide the element after 2 seconds allowing the screenshot to be taken while the element is shown
    window.setTimeout(hidePdfElements, 2000);
}

function hidePdfElements() {
    var pdf_title = document.getElementById("pdf_title");
    pdf_title.style.display = "none";

    var pdf_url = document.getElementById("pdf_url");
    pdf_url.style.display = "none";
}

/**
 * function to be executed when we want to print a page
 * (custom version for this page)
 */
var printUpdate = function () {
    /**
     * reflow all Highcharts instances across all sections
     */
    $('#section_1_chart_1_1').highcharts().reflow();
    $('#section_1_chart_1_2').highcharts().reflow();
    $('#section_1_chart_2_1').highcharts().reflow();
    $('#section_1_chart_2_2').highcharts().reflow();

    $('#section_2_chart_1_1').highcharts().reflow();
    $('#section_2_chart_1_2').highcharts().reflow();
    $('#section_2_chart_2_1').highcharts().reflow();
    $('#section_2_chart_2_2').highcharts().reflow();

    $('#section_3_chart_1_1').highcharts().reflow();
    $('#section_3_chart_1_2').highcharts().reflow();
    $('#section_3_chart_2_1').highcharts().reflow();
    $('#section_3_chart_2_2').highcharts().reflow();
};

/**
 * initialise the arrays to append results to for download in CSV format
 */
var csv_data = [];

/**
 * file name and report title for CSV download
 */
var csv_filename = 'Zones_Report-' + moment().format("DD_MMMM_YYYY_HHmm") + '.csv';
var csv_title    = 'GEO-Sense: Zones Report ({{user.venue_name}})';
var venue_name   = '{{user.venue_name}}';

/**
 * respond to click on the CSV download button
 * only collect data for sections where a zone has been selected
 */
$('#csv_button').on('click', function() {
    /**
     * get the data from the page for Zone #1
     */
    if ($('#section_1_select_zone_id').val()) {
        csv_data.push({
            heading: 'Overall metrics for Zone #1: ' + $( "#section_1_select_zone_id option:selected" ).text(),
            process: true,
            data: [['Selected Range', 'Average visitors per year', 'Average visitors per month', 'Average visitors per week', 'Average visitors per day', 'Total visitors this period', 'Busiest time of day', 'Average dwell time', 'Average visitors per day'],
                   [
                        $('#section_1_page_daterange_selected_large').text().replace(/,/g , ''),
                        $('#section_1_donut_5').text().replace(/,/g , ''),
                        $('#section_1_donut_6').text().replace(/,/g , ''),
                        $('#section_1_donut_7').text().replace(/,/g , ''),
                        $('#section_1_donut_8').text().replace(/,/g , ''),
                        $('#section_1_donut_1').text().replace(/,/g , ''),
                        $('#section_1_donut_2').text().replace(/,/g , ''),
                        $('#section_1_donut_3').text().replace(/,/g , ''),
                        $('#section_1_donut_4').text().replace(/,/g , ''),
                   ]]
           /**
            * when process is true there must be at least two arrays (lines) of content: headers and data
            */
        });

        csv_data.push({
            heading: 'Busiest Zones',
            process: false,
            data: $('#section_1_chart_1_1').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });

        csv_data.push({
            heading: 'Total Visitors - New Vs Repeat',
            process: false,
            data: $('#section_1_chart_1_2').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });

        csv_data.push({
            heading: 'Number of Visitors - New Vs Repeat',
            process: false,
            data: $('#section_1_chart_2_1').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });

        csv_data.push({
            heading: 'Dwell time analysis',
            process: false,
            data: $('#section_1_chart_2_2').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });
    } else {
        console.log('section 1 does NOT have a selected zone');
    }

    /**
     * get the data from the page for Zone #2
     */
    if ($('#section_2_select_zone_id').val()) {
        csv_data.push({
            heading: 'Overall metrics for Zone #2: ' + $( "#section_2_select_zone_id option:selected" ).text(),
            process: true,
            data: [['Selected Range', 'Average visitors per year', 'Average visitors per month', 'Average visitors per week', 'Average visitors per day', 'Total visitors this period', 'Busiest time of day', 'Average dwell time', 'Average visitors per day'],
                   [
                        $('#section_2_page_daterange_selected_large').text().replace(/,/g , ''),
                        $('#section_2_donut_5').text().replace(/,/g , ''),
                        $('#section_2_donut_6').text().replace(/,/g , ''),
                        $('#section_2_donut_7').text().replace(/,/g , ''),
                        $('#section_2_donut_8').text().replace(/,/g , ''),
                        $('#section_2_donut_1').text().replace(/,/g , ''),
                        $('#section_2_donut_2').text().replace(/,/g , ''),
                        $('#section_2_donut_3').text().replace(/,/g , ''),
                        $('#section_2_donut_4').text().replace(/,/g , ''),
                   ]]
           /**
            * when process is true there must be at least two arrays (lines) of content: headers and data
            */
        });

        csv_data.push({
            heading: 'Busiest Zones',
            process: false,
            data: $('#section_2_chart_1_1').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });

        csv_data.push({
            heading: 'Total Visitors - New Vs Repeat',
            process: false,
            data: $('#section_2_chart_1_2').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });

        csv_data.push({
            heading: 'Number of Visitors - New Vs Repeat',
            process: false,
            data: $('#section_2_chart_2_1').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });

        csv_data.push({
            heading: 'Dwell time analysis',
            process: false,
            data: $('#section_2_chart_2_2').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });
    } else {
        console.log('section 2 does NOT have a selected zone');
    }

    /**
     * get the data from the page for Zone #3
     */
    if ($('#section_3_select_zone_id').val()) {
        csv_data.push({
            heading: 'Overall metrics for Zone #3: ' + $( "#section_3_select_zone_id option:selected" ).text(),
            process: true,
            data: [['Selected Range', 'Average visitors per year', 'Average visitors per month', 'Average visitors per week', 'Average visitors per day', 'Total visitors this period', 'Busiest time of day', 'Average dwell time', 'Average visitors per day'],
                   [
                        $('#section_3_page_daterange_selected_large').text().replace(/,/g , ''),
                        $('#section_3_donut_5').text().replace(/,/g , ''),
                        $('#section_3_donut_6').text().replace(/,/g , ''),
                        $('#section_3_donut_7').text().replace(/,/g , ''),
                        $('#section_3_donut_8').text().replace(/,/g , ''),
                        $('#section_3_donut_1').text().replace(/,/g , ''),
                        $('#section_3_donut_2').text().replace(/,/g , ''),
                        $('#section_3_donut_3').text().replace(/,/g , ''),
                        $('#section_3_donut_4').text().replace(/,/g , ''),
                   ]]
           /**
            * when process is true there must be at least two arrays (lines) of content: headers and data
            */
        });

        csv_data.push({
            heading: 'Busiest Zones',
            process: false,
            data: $('#section_3_chart_1_1').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });

        csv_data.push({
            heading: 'Total Visitors - New Vs Repeat',
            process: false,
            data: $('#section_3_chart_1_2').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });

        csv_data.push({
            heading: 'Number of Visitors - New Vs Repeat',
            process: false,
            data: $('#section_3_chart_2_1').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });

        csv_data.push({
            heading: 'Dwell time analysis',
            process: false,
            data: $('#section_3_chart_2_2').highcharts().getCSV() // when process is false we just push the output from Highcharts
        });
    } else {
        console.log('section 3 does NOT have a selected zone');
    }

    exportToCsv(csv_filename, csv_title, venue_name, csv_data);
});

/**
 * Set the global timezone for this session for use in moment.js
 */
moment.tz.setDefault('{{current_user.primaryVenue.time_zone}}');
moment.updateLocale('en', {
    week : {
        dow : 1,
    }
});

/**
 * empty weekends array for plotbands
 */
var weekends = [];

/**
 * general configuration options for all donut charts
 */
var metricsDonutChartOptions = {
    chart: {
        type: 'pie',
        backgroundColor: '#FFFFFF',
        plotBorderWidth: null,
        plotShadow: false,
        spacingTop: 0,
        spacingBottom: 0,
        spacingLeft: 0,
        spacingRight: 0
    },
    plotOptions: {
        pie: {
            innerSize: '80%',
            center: ['50%', '50%'],
            borderWidth: 0,
            allowPointSelect: false,
            cursor: false,
            showInLegend: true,
            dataLabels: {
                enabled: false,
            }
        },
        series: {
            states: {
                hover: {
                    enabled: false
                }
            }
        }
    },
    legend: {
        enabled: false
    },
    tooltip: {
        enabled: false
    },
    title: {
        verticalAlign: 'middle',
        floating: true
    }
};
</script>

<script type="text/javascript">
$(document).ready(function() {
    /***************************************************************
     * preparations for section 1 from here
     ***************************************************************/

    /*******************************************************************
     * start of timeOfDay average: chart 1.1
     * container: chart_1_1
     * url: api/zone_report/visitors_per_hourofday/$zone_id/$start/$end
     *******************************************************************/
    var chart_1_1_Options = {
        chart: {
            renderTo: 'section_1_chart_1_1',
            backgroundColor: '#FFFFFF',
            type: 'area'
        },
        xAxis: {
            type: 'category'
        },
        tooltip: {
            shared: true,
            formatter: function () {
                var tooltipcontent = '<b>Between ' + this.x + ':00 and ' + (this.x+1) + ':00</b>';
                // we have to loop here as we don't yet know how many series we will have
                $.each(this.points, function () {
                    tooltipcontent += '<br/>' + this.series.name + ': ' +
                        this.y.toLocaleString();
                });

                return tooltipcontent;
            }
        },
        legend: {
            enabled: true
        }
    };

    function onChart_1_1_DataReceived(data) {
        /**
         * do something with the data
         */
        var seriesoptions = [
            {
                type: 'area',
                color: '#e25826', // e25826
                name: 'average visitors'
            }
        ];

        chart_1_1_Options.series = seriesoptions;
        chart_1_1 = new Highcharts.Chart(chart_1_1_Options);
        chart_1_1.series[0].setData(data);

        /**
         * here we also get the busiest hour and send that to donut 4
         */
        var hours = _.sortBy(data, function(value, key) {
            return value[1];
        });

        if (hours.length > 0) {
            $('#section_1_donut_2').html((_.last(hours)[0]) + ':00 - ' + (_.last(hours)[0] + 1) + ':00');
        } else {
            $('#section_1_donut_2').html('<span style="font-size: 60%;">no data</span>');
        }

    }
    /***************************************************************
     * end of chart 1.1
     ***************************************************************/

    /***************************************************************
     * start of new/repeat chart
     * container: chart_1_2
     ***************************************************************/
    var chart_1_2_Options = {
        chart: {
            type: 'pie',
            renderTo: 'section_1_chart_1_2',
            backgroundColor: '#FFFFFF',
            plotBorderWidth: null,
            plotShadow: false,
            spacingTop: 0,
            spacingBottom: 0,
            spacingLeft: 0,
            spacingRight: 0
        },
        plotOptions: {
            pie: {
                innerSize: '65%',
                center: ['50%', '50%'],
                borderWidth: 0,
                allowPointSelect: false,
                cursor: false,
                showInLegend: true,
                point: {
                    events: {
                        legendItemClick: function () {
                            return false;
                        }
                    }
                }
            },
            series: {
                states: {
                    hover: {
                        enabled: false
                    }
                }
            }
        },
        legend: {
            align: 'right',
            verticalAlign: 'top',
            layout: 'vertical',
            floating: true
        },
        tooltip: {
            formatter: function () {
                var tooltipcontent = '<b>' + this.key + '</b><br>' + (Math.round(this.percentage*10))/10 + '% (' + this.y.toLocaleString() + ' of ' + this.total.toLocaleString() + ')';
                return tooltipcontent;
            }
        },
        title: {
            align: 'center',
            verticalAlign: 'middle',
            y: 10
        },
        series: [{
            name: "visitors",
            data: [{
                name: "new visitors",
                y: 0,
                color: '#e25826'
            },
            {
                name: "repeat visitors",
                y: 0,
                color: '#132149'
            }]
        }]
    };

    /***************************************************************
     * end of chart 1.2
     ***************************************************************/

    /***************************************************************
     * start of visitor stats chart
     * container: section_1_chart_2_1
     * plotbands: weekends
     * sync with: section_1_chart_2_2
     ***************************************************************/
    var chart_2_1_Options = {
        chart: {
            renderTo: 'section_1_chart_2_1',
            backgroundColor: '#FFFFFF',
            zoomType: 'x'
        },
        xAxis: {
            type: 'datetime',
            plotBands: weekends,
            events: {
                /**
                 * sync charts when zoom is triggered
                 */
                afterSetExtremes: function (event) {
                    var xMin = event.min;
                    var xMax = event.max;
                    var section_1_chart_2_2 = $('#section_1_chart_2_2').highcharts();
                    var ex = section_1_chart_2_2.xAxis[0].getExtremes();
                    if (ex.min != xMin || ex.max != xMax) section_1_chart_2_2.xAxis[0].setExtremes(xMin, xMax, true, false);
                }
            }
        },
        plotOptions: {
            column: {
                borderWidth: 0,
                stacking: 'normal'
            }
        },
        legend: {
            enabled: true
        }
    };

    /**
     * callback to be called from the bundled ajax calls
     */
    function onChart_2_1_DataReceived(data) {
        /**
         * Load all the data for the chart
         */
        if (typeof data.new == 'undefined' || data.new == null) {
            data.new = [];
        }

        if (typeof data.repeat == 'undefined' || data.repeat == null) {
            data.repeat = [];
        }

        /**
         * do something with the data
         */
        var seriesoptions = [
            {
                type: 'column', // default chart type
                lineWidth: 2,
                states: {
                    hover: {
                        enabled: true,
                        lineWidth: 2
                    }
                },
                color: '#e25826',
                name: 'new visitors',
                stack: 'visitors'
            },
            {
                type: 'column', // default chart type
                lineWidth: 2,
                states: {
                    hover: {
                        enabled: true,
                        lineWidth: 2
                    }
                },
                color: '#132149',
                name: 'repeat visitors',
                stack: 'visitors'
            }
        ];

        /**
         * when date range is longer than 5 weeks we switch to area chart instead of column
         */
        if (data.new && data.new.length > 5*7) {
            seriesoptions[0].type = 'area';
            seriesoptions[1].type = 'area';
        }

        chart_2_1_Options.yAxis = {
            stackLabels: {
                useHTML: true,
                enabled: true,
                align: 'center',
                verticalAlign: 'top',
                formatter: function () {
                    var day_epoch  = this.x;
                    var event = '';
                    var event_categories = [];
                    $.each(data.event, function(key, value) {
                        if (day_epoch >= value['start_date'] && day_epoch <= value['end_date']) {
                            if (event_categories.length == 0) {
                                event = `<span padding-top: 20px;><i style="background-color:` + value['color'] + `" class="circle-icon fa fa-calendar"></i></span>`;
                                event_categories.push(value['category_id']); 
                            }

                            if ($.inArray(value['category_id'], event_categories) == -1) {
                                event += `<br><span><i style="background-color:` + value['color'] + `" class="circle-icon fa fa-calendar fa-sm"></i></span>`;
                                event_categories.push(value['category_id']); 
                            }
                        }
                    });
                    return event;
                }
            }
        }

        chart_2_1_Options.tooltip = {
            shared: true,
            useHTML: true,
            borderWidth: 0,
            backgroundColor: "rgba(255,255,255,0)",
            shadow: false,
            formatter: function () {
                var tooltipcontent = '<b>' + moment(this.x).format("dddd, D MMMM YYYY") + '</b>';
                var mySum = 0;

                var day_epoch  = this.x;
                $.each(data.event, function(key, value) {
                    if (day_epoch >= value['start_date'] && day_epoch <= value['end_date']) {
                        tooltipcontent += '<p><b>Event: </b>' + value['name'] + '</p>';
                    }
                });

                tooltipcontent += '<table style="width:100%">';

                /**
                 * we have to loop here as we don't yet know how many series we will have
                 */
                $.each(this.points, function () {
                    var symbol = '■';
                    tooltipcontent += '<tr><td><span style="color:' + this.point.color + '">' + symbol + '</span> ' + this.series.name + ':</td><td style="text-align: right;">' + this.y.toLocaleString() + '</td></tr>';
                    mySum += this.y;
                });

                tooltipcontent += '<tr><td><b>Total:</b></td><td style="text-align: right;"><b>' + mySum.toLocaleString() + '</b><td></tr>';
                tooltipcontent += '</table>';

                return tooltipcontent;
            }
        }

        chart_2_1_Options.series = seriesoptions;
        var chart_2_1 = new Highcharts.Chart(chart_2_1_Options);
        chart_2_1.series[0].setData(noGapsDataArray(data.new, 86400));
        chart_2_1.series[1].setData(noGapsDataArray(data.repeat, 86400));
        chart_2_1.xAxis[0].update({
            plotBands: weekends
        });

        /**
         * NOTE: with this function we also feed the "total visitors" data to chart 1.2
         */
        var totalnew = 0;
        _.forEach(data.new, function(value) {
            totalnew += value[1];
        });

        var totalrepeat = 0;
        _.forEach(data.repeat, function(value) {
            totalrepeat += value[1];
        });

        /**
         * define font size percentage for the donut contents, reduce size if total is over 1M
         */
        var chart_1_2__font_size_perc = 150;
        if (totalnew + totalrepeat >= 1000000) {
            var chart_1_2__font_size_perc = 120;
        }

        chart_1_2_Options.title.text = '<b style="font-size: ' + chart_1_2__font_size_perc + '%; font-weight: bold;">' + (totalnew + totalrepeat).toLocaleString() + '</b><br><b>Total</b>';
        var chart_1_2 = new Highcharts.Chart(chart_1_2_Options);
        chart_1_2.series[0].setData([totalnew, totalrepeat]);
    }

    /**************************************************************
     * end of chart 2.1
     **************************************************************/

    /***************************************************************
     * start of dwell time analysis chart
     * container: section_1_chart_2_2
     * plotbands: weekends
     * sync with: section_1_chart_2_1
     ***************************************************************/
    var chart_2_2_Options = $.extend(true, {}, dwell_time_analysis_options);
    chart_2_2_Options.chart.renderTo = 'section_1_chart_2_2';
    chart_2_2_Options.xAxis.plotBands = weekends;
    chart_2_2_Options.chart.zoomType = 'x';
    chart_2_2_Options.xAxis.events = {
        /**
         * sync charts when zoom is triggered
         */
        afterSetExtremes: function (event) {
            var xMin = event.min;
            var xMax = event.max;
            var chart_2_1 = $('#section_1_chart_2_1').highcharts();
            var ex = chart_2_1.xAxis[0].getExtremes();
            if (ex.min != xMin || ex.max != xMax) chart_2_1.xAxis[0].setExtremes(xMin, xMax, true, false);
        }
    };

    /**
     * callback to be called from the bundled ajax calls
     */
    function onChart_2_2_DataReceived(data) {
        /**
         * define the series received
         */
        var seriesoptions = [
            {
                type: 'line',
                name: 'average dwelltime',
                yAxis: 1,
                color: '#C6D4FC',
                dashStyle: 'LongDash'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_5_label}}',
                color: '#949898'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_4_label}}',
                color: '#5A5A5A'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_3_label}}',
                color: '#6EB553'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_2_label}}',
                color: '#4E5977'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_1_label}}',
                color: '#E9825C'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_skipped_label}}',
                visible: false,
                color: '#DD686E' // otherwise this becomes purple
            }
        ];

        /**
         * if our date range is longer than 2 days, we disable the markers for clean lines
         * if shorter we switch to a stacked column chart
         */
        if (data['dt_level_1'].length > 2) {
            chart_2_2_Options.plotOptions.series.marker.enabled = false;
        } else {
            chart_2_2_Options.plotOptions.series.marker.enabled = true;

            $.each(seriesoptions, function () {
                if (this.type == 'area') {
                    this.type = 'column';
                }
            });
        }

        chart_2_2_Options.series = seriesoptions;
        chart_2_2 = new Highcharts.Chart(chart_2_2_Options);
        chart_2_2.series[6].setData(noGapsDataArray(data['dt_skipped'], 86400));
        chart_2_2.series[5].setData(noGapsDataArray(data['dt_level_1'], 86400));
        chart_2_2.series[4].setData(noGapsDataArray(data['dt_level_2'], 86400));
        chart_2_2.series[3].setData(noGapsDataArray(data['dt_level_3'], 86400));
        chart_2_2.series[2].setData(noGapsDataArray(data['dt_level_4'], 86400));
        chart_2_2.series[1].setData(noGapsDataArray(data['dt_level_5'], 86400));
        chart_2_2.series[0].setData(noGapsDataArray(data['dt_average'], 86400));
        chart_2_2.xAxis[0].update({
            plotBands: weekends
        });
    }

    /***************************************************************
     * end of chart 2.2
     ***************************************************************/

    /**
     * trigger on change of the <select> element:
     * - first provide feedback that the metric are going to be refreshed by spinning the metrics of the top row donuts
     * - we then get the "static" metrics (average visitors for various time units) for the top row donuts with ajax
     * - initialise all major charts
     * - initiate the ajax function to get these average visitor metrics
     * - initiate the daterangepicker to collect metrics for the default datarange
     * - allow the user to modify the daterange for selected zone
     */
    $('#section_1_select_zone_id').on('change', function() {
        /**
         * display all elements with the class for the first section
         */
        $('.zone_report_section_1').slideDown(200);

        var selected_zone_1 = this.value;

        /**
         * initialize both charts
         * first clear the data/series for the charts if they already exist
         */
        if (typeof $('#section_1_chart_1_1').highcharts() !== 'undefined') {
            $('#section_1_chart_1_1').highcharts().series[0].setData([]);
        }

        if (typeof $('#section_1_chart_1_2').highcharts() !== 'undefined') {
            $('#section_1_chart_1_2').highcharts().series[0].setData([0,0]);
        }

        if (typeof $('#section_1_chart_2_1').highcharts() !== 'undefined') {
            $('#section_1_chart_2_1').highcharts().series[0].setData([]);
            $('#section_1_chart_2_1').highcharts().series[1].setData([]);
        }

        if (typeof $('#section_1_chart_2_2').highcharts() !== 'undefined') {
            $('#section_1_chart_2_2').highcharts().series[0].setData([]);
            $('#section_1_chart_2_2').highcharts().series[1].setData([]);
            $('#section_1_chart_2_2').highcharts().series[2].setData([]);
            $('#section_1_chart_2_2').highcharts().series[3].setData([]);
            $('#section_1_chart_2_2').highcharts().series[4].setData([]);
            $('#section_1_chart_2_2').highcharts().series[5].setData([]);
        }

        var chart_1_1 = new Highcharts.Chart(chart_1_1_Options);
        var chart_1_2 = new Highcharts.Chart(chart_1_2_Options);
        var chart_2_1 = new Highcharts.Chart(chart_2_1_Options);
        var chart_2_2 = new Highcharts.Chart(chart_2_2_Options);

        chart_1_1.showLoading();
        chart_1_2.showLoading();
        chart_2_1.showLoading();
        chart_2_2.showLoading();

        /**
         * we also empty the title (centered in the donut) for chart 1.2, just make the transition smoother
         */
        chart_1_2.setTitle({ text: '' });

        /**
         * initialize the top row donuts
         */
        $('#section_1_donut_5').html('<i class="fa fa-spinner fa-spin"></i>');
        $('#section_1_donut_6').html('<i class="fa fa-spinner fa-spin"></i>');
        $('#section_1_donut_7').html('<i class="fa fa-spinner fa-spin"></i>');
        $('#section_1_donut_8').html('<i class="fa fa-spinner fa-spin"></i>');

        $.ajax({
            url:        '{{site.uri.public}}/geo-sense/api/visitor_report/alltime_averages/zone/' + selected_zone_1,
            type:       'GET',
            dataType:   'json',
            success:    onAvgVisitorMetricsReceived
        });

        /***************************************************************
         * daterangepicker and ajax loading of all the data from here
         ***************************************************************/
        /**
         * define default start and end for the page
         */
        var rangeStart = moment().startOf('day').subtract(1, 'days');
        var rangeEnd   = moment().startOf('day').subtract(1, 'days').endOf('day');

        /*
        initiate the daterangepicker with initial start/end and Label
        */
        page_daterange(rangeStart, rangeEnd);

        /**
         * functions to display the "active" custom date range and the picker for current page
         */
        $('#section_1_page_daterange').daterangepicker({
            timePicker:             true,
            timePicker24Hour:       true,
            timePickerIncrement:    15,
            showISOWeekNumbers:     true,
            locale: {
                format: "DD/MM/YYYY",
                firstDay: 1
            },
            ranges: {
               'Yesterday':                 [moment().startOf('day').subtract(1, 'days'), moment().startOf('day').subtract(1, 'days').endOf('day')],
               'This Week to-date':         [rangeStart, rangeEnd], //default value for the page
               'Past Month':                [moment().startOf('day').subtract(1, 'months'), moment()],
               'Previous Week same range':  [moment().startOf('week').subtract(1, 'weeks'), moment().subtract(1, 'weeks')],
               'Same Week 4 Weeks ago':     [moment().startOf('week').subtract(4, 'weeks'), moment().subtract(4, 'weeks')],
               'This Month to-date':        [moment().startOf('month'), moment().endOf('month')],
               'All Time':                  ['{{current_user.primaryVenue.capture_start | date("d/m/Y", "Europe/London")}}', moment()]
            },
            startDate:  rangeStart,
            endDate:    rangeEnd,
            minDate:    '{{current_user.primaryVenue.venue_tracking.capture_start | date("d/m/Y", "Europe/London")}}',
            maxDate:    moment().startOf('day'),
            opens:      'left'
        }, page_daterange);

        /**
         * callback function to execute upon selected date range
         */
        function page_daterange(start, end) {
            $(window).trigger('resize');

            if (end.diff(start) === 0) {
                console.log('we have difference between start and end of zero: we will add 1 hour to end');
                end.add(1, 'hour');
            }

            newRangeStart = start;
            newRangeEnd   = end;

            /**
             * update the weekend plotbands
             */
            weekends = weekendAreasDaily(start, end);

            /**
             * then we need to set the charts, <div>s and <spans>s which will be refreshed, to their loading state
             */
            var chart_1_1 = $("#section_1_chart_1_1").highcharts();
            var chart_1_2 = $("#section_1_chart_1_2").highcharts();
            var chart_2_1 = $("#section_1_chart_2_1").highcharts();
            var chart_2_2 = $("#section_1_chart_2_2").highcharts();

            chart_1_1.showLoading();
            chart_1_2.showLoading();
            chart_2_1.showLoading();
            chart_2_2.showLoading();

            $('#section_1_donut_1').html('<i class="fa fa-spinner fa-spin"></i>');
            $('#section_1_donut_2').html('<i class="fa fa-spinner fa-spin"></i>');
            $('#section_1_donut_3').html('<i class="fa fa-spinner fa-spin"></i>');
            $('#section_1_donut_4').html('<i class="fa fa-spinner fa-spin"></i>');

            /**
             * place the selected range in the <span> at the top of the page
             */
            $('#section_1_page_daterange_selected_large').html('<b>' + start.format('H:mm dddd, D MMMM YYYY') + ' - ' + end.format('H:mm dddd, D MMMM YYYY') + '</b>');
            $('#section_1_page_daterange_selected_small').html('<b>' + start.format('ddd, D MMM YYYY') + ' - ' + end.format('ddd, D MMM YYYY') + '</b>');
            console.log(start + ':' + end);

            /**
             * from here we call all ajax sources with the newly selected start/end:
             */

            /**
             * get the average dwell time for donut_3
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/stats/average_dwelltime/zone/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onDonut_3_DataReceived
            });

            /**
             * get the data for donut_1, donut_4
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/visitor_report/unique_daily/zone/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onDonut_1_DataReceived
            });

            /**
             * get the data for chart 1.1, donut_2
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/zone_report/visitors_per_hourofday/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onChart_1_1_DataReceived
            });

            /**
             * get the data for chart 2.1 and 1.2
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/zone_report/new_vs_repeat/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onChart_2_1_DataReceived
            });

            /**
             * get the data for chart 2.2
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/stats/zone/visitors_durations/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onChart_2_2_DataReceived
            });
        }
        /**************************************************************
         * end of daterangepicker and ajax data loading
         **************************************************************/
    });

    /**
     * then push the received average visitor metrics to the top row donuts
     */
    function onAvgVisitorMetricsReceived(data) {
        console.log(data);
        $('#section_1_donut_5').html(data.average_yearly.toLocaleString());
        $('#section_1_donut_6').html(data.average_monthly.toLocaleString());
        $('#section_1_donut_7').html(data.average_weekly.toLocaleString());
        $('#section_1_donut_8').html(data.average_daily.toLocaleString());
    }

    /**
     * push the received data to donut_3
     */
    function onDonut_3_DataReceived(data) {
        // Load all the data into the DOM
        $('#section_1_donut_3').html(data + ' <span style="font-size: 60%;">minutes</span>');
    }

    /**
     * push the received data to donut_4
     */
    function onDonut_1_DataReceived(data) {
        /**
         * NOTE: with this function we also feed the "total visitors" data to donut 4
         * - count length in days between first and last element in series
         * - or do we use the number of days we have data for to calculate averages?
         */
        var total_visitors = 0;
        var counter = data.length;
        _.forEach(data, function(value, key) {
            total_visitors += value[1];
        });

        if (counter > 1) {
            var average = Math.round(total_visitors/counter);
        } else {
            var average = total_visitors;
        }

        console.log('total visitors: ' + total_visitors + ' # of days we work with: ' + counter);

        $('#section_1_donut_1').html(total_visitors.toLocaleString());
        $('#section_1_donut_4').html(average.toLocaleString());
    }
    /*****************************************************************
     * end of top row donut charts
     *****************************************************************/

    /**
     * force a resize event after page load
     */
    window.dispatchEvent(new Event('resize'));
});
</script>

<script type="text/javascript">
$(document).ready(function() {
    /***************************************************************
     * preparations for section 3 from here
     ***************************************************************/

    /*******************************************************************
     * start of timeOfDay average: chart 1.1
     * container: chart_1_1
     * url: api/zone_report/visitors_per_hourofday/$zone_id/$start/$end
     *******************************************************************/
    var chart_1_1_Options = {
        chart: {
            renderTo: 'section_2_chart_1_1',
            backgroundColor: '#FFFFFF',
            type: 'area'
        },
        xAxis: {
            type: 'category'
        },
        tooltip: {
            shared: true,
            formatter: function () {
                var tooltipcontent = '<b>Between ' + this.x + ':00 and ' + (this.x+1) + ':00</b>';
                // we have to loop here as we don't yet know how many series we will have
                $.each(this.points, function () {
                    tooltipcontent += '<br/>' + this.series.name + ': ' +
                        this.y.toLocaleString();
                });

                return tooltipcontent;
            }
        },
        legend: {
            enabled: true
        }
    };

    function onChart_1_1_DataReceived(data) {
        /**
         * do something with the data
         */
        var seriesoptions = [
            {
                type: 'area',
                color: '#e25826', // e25826
                name: 'average visitors'
            }
        ];

        chart_1_1_Options.series = seriesoptions;
        chart_1_1 = new Highcharts.Chart(chart_1_1_Options);
        chart_1_1.series[0].setData(data);

        /**
         * here we also get the busiest hour and send that to donut 4
         */
        var hours = _.sortBy(data, function(value, key) {
            return value[1];
        });

        if (hours.length > 0) {
            $('#section_2_donut_2').html((_.last(hours)[0]) + ':00 - ' + (_.last(hours)[0] + 1) + ':00');
        } else {
            $('#section_2_donut_2').html('<span style="font-size: 60%;">no data</span>');
        }

    }
    /***************************************************************
     * end of chart 1.1
     ***************************************************************/

    /***************************************************************
     * start of new/repeat chart
     * container: chart_1_2
     ***************************************************************/
    var chart_1_2_Options = {
        chart: {
            type: 'pie',
            renderTo: 'section_2_chart_1_2',
            backgroundColor: '#FFFFFF',
            plotBorderWidth: null,
            plotShadow: false,
            spacingTop: 0,
            spacingBottom: 0,
            spacingLeft: 0,
            spacingRight: 0
        },
        plotOptions: {
            pie: {
                innerSize: '65%',
                center: ['50%', '50%'],
                borderWidth: 0,
                allowPointSelect: false,
                cursor: false,
                showInLegend: true,
                point: {
                    events: {
                        legendItemClick: function () {
                            return false;
                        }
                    }
                }
            },
            series: {
                states: {
                    hover: {
                        enabled: false
                    }
                }
            }
        },
        legend: {
            align: 'right',
            verticalAlign: 'top',
            layout: 'vertical',
            floating: true
        },
        tooltip: {
            formatter: function () {
                var tooltipcontent = '<b>' + this.key + '</b><br>' + (Math.round(this.percentage*10))/10 + '% (' + this.y.toLocaleString() + ' of ' + this.total.toLocaleString() + ')';
                return tooltipcontent;
            }
        },
        title: {
            align: 'center',
            verticalAlign: 'middle',
            y: 10
        },
        series: [{
            name: "visitors",
            data: [{
                name: "new visitors",
                y: 0,
                color: '#e25826'
            },
            {
                name: "repeat visitors",
                y: 0,
                color: '#132149'
            }]
        }]
    };

    /***************************************************************
     * end of chart 1.2
     ***************************************************************/

    /***************************************************************
     * start of visitor stats chart
     * container: chart_2_1
     ***************************************************************/
    var chart_2_1_Options = {
        chart: {
            renderTo: 'section_2_chart_2_1',
            backgroundColor: '#FFFFFF',
            zoomType: 'x'
        },
        xAxis: {
            type: 'datetime',
            plotBands: weekends,
            events: {
                /**
                 * sync charts when zoom is triggered
                 */
                afterSetExtremes: function (event) {
                    var xMin = event.min;
                    var xMax = event.max;
                    var chart_2_2 = $('#section_2_chart_2_2').highcharts();
                    var ex = chart_2_2.xAxis[0].getExtremes();
                    if (ex.min != xMin || ex.max != xMax) chart_2_2.xAxis[0].setExtremes(xMin, xMax, true, false);
                }
            }
        },
        tooltip: {
            shared: true,
            formatter: function () {
                var tooltipcontent = '<b>' + moment(this.x).format("dddd, D MMMM YYYY") + '</b>';

                /**
                 * we have to loop here as we don't yet know how many series we will have
                 */
                $.each(this.points, function () {
                    symbol = '■';
                    tooltipcontent += '<br/><span style="color:' + this.point.color + '">' + symbol + '</span> ' + this.series.name + ': ' +
                        this.y.toLocaleString();
                });

                return tooltipcontent;
            }
        },
        plotOptions: {
            column: {
                borderWidth: 0,
                stacking: 'normal'
            }
        },
        legend: {
            enabled: true
        }
    };

    /**
     * callback to be called from the bundled ajax calls
     */
    function onChart_2_1_DataReceived(data) {
        /**
         * Load all the data for the chart
         */
        if (typeof data.new == 'undefined' || data.new == null) {
            data.new = [];
        }

        if (typeof data.repeat == 'undefined' || data.repeat == null) {
            data.repeat = [];
        }

        /**
         * do something with the data
         */
        var seriesoptions = [
            {
                type: 'column', // default chart type
                lineWidth: 2,
                states: {
                    hover: {
                        enabled: true,
                        lineWidth: 2
                    }
                },
                color: '#e25826',
                name: 'new visitors',
                stack: 'visitors'
            },
            {
                type: 'column', // default chart type
                lineWidth: 2,
                states: {
                    hover: {
                        enabled: true,
                        lineWidth: 2
                    }
                },
                color: '#132149',
                name: 'repeat visitors',
                stack: 'visitors'
            }
        ];

        /**
         * when date range is longer than 5 weeks we switch to area chart instead of column
         */
        if (data.new && data.new.length > 5*7) {
            seriesoptions[0].type = 'area';
            seriesoptions[1].type = 'area';
        }

        chart_2_1_Options.yAxis = {
            stackLabels: {
                useHTML: true,
                enabled: true,
                align: 'center',
                verticalAlign: 'top',
                formatter: function () {
                    var day_epoch  = this.x;
                    var event = '';
                    var event_categories = [];
                    $.each(data.event, function(key, value) {
                        if (day_epoch >= value['start_date'] && day_epoch <= value['end_date']) {
                            if (event_categories.length == 0) {
                                event = `<span padding-top: 20px;><i style="background-color:` + value['color'] + `" class="circle-icon fa fa-calendar"></i></span>`;
                                event_categories.push(value['category_id']); 
                            }

                            if ($.inArray(value['category_id'], event_categories) == -1) {
                                event += `<br><span><i style="background-color:` + value['color'] + `" class="circle-icon fa fa-calendar fa-sm"></i></span>`;
                                event_categories.push(value['category_id']); 
                            }
                        }
                    });
                    return event;
                }
            }
        }

        chart_2_1_Options.tooltip = {
            shared: true,
            useHTML: true,
            borderWidth: 0,
            backgroundColor: "rgba(255,255,255,0)",
            shadow: false,
            formatter: function () {
                var tooltipcontent = '<b>' + moment(this.x).format("dddd, D MMMM YYYY") + '</b>';
                var mySum = 0;

                var day_epoch  = this.x;
                $.each(data.event, function(key, value) {
                    if (day_epoch >= value['start_date'] && day_epoch <= value['end_date']) {
                        tooltipcontent += '<p><b>Event: </b>' + value['name'] + '</p>';
                    }
                });

                tooltipcontent += '<table style="width:100%">';

                /**
                 * we have to loop here as we don't yet know how many series we will have
                 */
                $.each(this.points, function () {
                    var symbol = '■';
                    tooltipcontent += '<tr><td><span style="color:' + this.point.color + '">' + symbol + '</span> ' + this.series.name + ':</td><td style="text-align: right;">' + this.y.toLocaleString() + '</td></tr>';
                    mySum += this.y;
                });

                tooltipcontent += '<tr><td><b>Total:</b></td><td style="text-align: right;"><b>' + mySum.toLocaleString() + '</b><td></tr>';
                tooltipcontent += '</table>';

                return tooltipcontent;
            }
        }

        chart_2_1_Options.series = seriesoptions;
        var chart_2_1 = new Highcharts.Chart(chart_2_1_Options);
        chart_2_1.series[0].setData(noGapsDataArray(data.new, 86400));
        chart_2_1.series[1].setData(noGapsDataArray(data.repeat, 86400));
        chart_2_1.xAxis[0].update({
            plotBands: weekends
        });

        /**
         * NOTE: with this function we also feed the "total visitors" data to chart 1.2
         */
        var totalnew = 0;
        _.forEach(data.new, function(value) {
            totalnew += value[1];
        });

        var totalrepeat = 0;
        _.forEach(data.repeat, function(value) {
            totalrepeat += value[1];
        });

        /**
         * define font size percentage for the donut contents, reduce size if total is over 1M
         */
        var chart_1_2__font_size_perc = 150;
        if (totalnew + totalrepeat >= 1000000) {
            var chart_1_2__font_size_perc = 120;
        }

        chart_1_2_Options.title.text = '<b style="font-size: ' + chart_1_2__font_size_perc + '%; font-weight: bold;">' + (totalnew + totalrepeat).toLocaleString() + '</b><br><b>Total</b>';
        var chart_1_2 = new Highcharts.Chart(chart_1_2_Options);
        chart_1_2.series[0].setData([totalnew, totalrepeat]);
    }

    /**************************************************************
     * end of chart 2.1
     **************************************************************/

    /***************************************************************
     * start of dwell time analysis chart
     * container: section_2_chart_2_2
     * plotbands: weekends
     * sync with: section_2_chart_2_1
     ***************************************************************/
    var chart_2_2_Options = $.extend(true, {}, dwell_time_analysis_options);
    chart_2_2_Options.chart.renderTo = 'section_2_chart_2_2';
    chart_2_2_Options.xAxis.plotBands = weekends;
    chart_2_2_Options.chart.zoomType = 'x';
    chart_2_2_Options.xAxis.events = {
        /**
         * sync charts when zoom is triggered
         */
        afterSetExtremes: function (event) {
            var xMin = event.min;
            var xMax = event.max;
            var chart_2_1 = $('#section_2_chart_2_1').highcharts();
            var ex = chart_2_1.xAxis[0].getExtremes();
            if (ex.min != xMin || ex.max != xMax) chart_2_1.xAxis[0].setExtremes(xMin, xMax, true, false);
        }
    };

    /**
     * callback to be called from the bundled ajax calls
     */
    function onChart_2_2_DataReceived(data) {
        /**
         * define the series received
         */
        var seriesoptions = [
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_skipped_label}}',
                visible: false,
                color: '#DD686E' // otherwise this becomes purple ;-)
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_1_label}}'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_2_label}}'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_3_label}}'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_4_label}}'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_5_label}}'
            },
            {
                type: 'line',
                name: 'average dwelltime',
                yAxis: 1,
                color: '#C6D4FC',
                dashStyle: 'LongDash'
            }
        ];

        /**
         * if our date range is longer than 2 days, we disable the markers for clean lines
         * if shorter we switch to a stacked column chart
         */
        if (data['dt_level_1'].length > 2) {
            chart_2_2_Options.plotOptions.series.marker.enabled = false;
        } else {
            chart_2_2_Options.plotOptions.series.marker.enabled = true;

            $.each(seriesoptions, function () {
                if (this.type == 'area') {
                    this.type = 'column';
                }
            });
        }

        chart_2_2_Options.series = seriesoptions;
        chart_2_2 = new Highcharts.Chart(chart_2_2_Options);
        chart_2_2.series[0].setData(noGapsDataArray(data['dt_skipped'], 86400));
        chart_2_2.series[1].setData(noGapsDataArray(data['dt_level_1'], 86400));
        chart_2_2.series[2].setData(noGapsDataArray(data['dt_level_2'], 86400));
        chart_2_2.series[3].setData(noGapsDataArray(data['dt_level_3'], 86400));
        chart_2_2.series[4].setData(noGapsDataArray(data['dt_level_4'], 86400));
        chart_2_2.series[5].setData(noGapsDataArray(data['dt_level_5'], 86400));
        chart_2_2.series[6].setData(noGapsDataArray(data['dt_average'], 86400));
        chart_2_2.xAxis[0].update({
            plotBands: weekends
        });
    }

    /***************************************************************
     * end of chart 2.2
     ***************************************************************/

    /**
     * trigger on change of the <select> element:
     * - first provide feedback that the metric are going to be refreshed by spinning the metrics of the top row donuts
     * - we then get the "static" metrics (average visitors for various time units) for the top row donuts with ajax
     * - initialise all major charts
     * - initiate the ajax function to get these average visitor metrics
     * - initiate the daterangepicker to collect metrics for the default datarange
     * - allow the user to modify the daterange for selected zone
     */
    $('#section_2_select_zone_id').on('change', function() {
        /**
         * display all elements with the class for the second section
         */
        $('.zone_report_section_2').slideDown(200);

        var selected_zone_1 = this.value;

        /**
         * initialize both charts
         * first clear the data/series for the charts if they already exist
         */
        if (typeof $('#section_2_chart_1_1').highcharts() !== 'undefined') {
            $('#section_2_chart_1_1').highcharts().series[0].setData([]);
        }

        if (typeof $('#section_2_chart_1_2').highcharts() !== 'undefined') {
            $('#section_2_chart_1_2').highcharts().series[0].setData([0,0]);
        }

        if (typeof $('#section_2_chart_2_1').highcharts() !== 'undefined') {
            $('#section_2_chart_2_1').highcharts().series[0].setData([]);
            $('#section_2_chart_2_1').highcharts().series[1].setData([]);
        }

        if (typeof $('#section_2_chart_2_2').highcharts() !== 'undefined') {
            $('#section_2_chart_2_2').highcharts().series[0].setData([]);
            $('#section_2_chart_2_2').highcharts().series[1].setData([]);
            $('#section_2_chart_2_2').highcharts().series[2].setData([]);
            $('#section_2_chart_2_2').highcharts().series[3].setData([]);
            $('#section_2_chart_2_2').highcharts().series[4].setData([]);
            $('#section_2_chart_2_2').highcharts().series[5].setData([]);
        }

        var chart_1_1 = new Highcharts.Chart(chart_1_1_Options);
        var chart_1_2 = new Highcharts.Chart(chart_1_2_Options);
        var chart_2_1 = new Highcharts.Chart(chart_2_1_Options);
        var chart_2_2 = new Highcharts.Chart(chart_2_2_Options);

        chart_1_1.showLoading();
        chart_1_2.showLoading();
        chart_2_1.showLoading();
        chart_2_2.showLoading();

        /**
         * we also empty the title (centered in the donut) for chart 1.2, just make the transition smoother
         */
        chart_1_2.setTitle({ text: '' });

        /**
         * initialize the top row donuts
         */
        $('#section_2_donut_5').html('<i class="fa fa-spinner fa-spin"></i>');
        $('#section_2_donut_6').html('<i class="fa fa-spinner fa-spin"></i>');
        $('#section_2_donut_7').html('<i class="fa fa-spinner fa-spin"></i>');
        $('#section_2_donut_8').html('<i class="fa fa-spinner fa-spin"></i>');

        $.ajax({
            url:        '{{site.uri.public}}/geo-sense/api/visitor_report/alltime_averages/zone/' + selected_zone_1,
            type:       'GET',
            dataType:   'json',
            success:    onAvgVisitorMetricsReceived
        });

        /***************************************************************
         * daterangepicker and ajax loading of all the data from here
         ***************************************************************/
        /**
         * define default start and end for the page
         */
        var rangeStart = moment().startOf('day').subtract(1, 'days');
        var rangeEnd   = moment().startOf('day').subtract(1, 'days').endOf('day');

        /*
        initiate the daterangepicker with initial start/end and Label
        */
        page_daterange(rangeStart, rangeEnd);

        /**
         * functions to display the "active" custom date range and the picker for current page
         */
        $('#section_2_page_daterange').daterangepicker({
            timePicker:             true,
            timePicker24Hour:       true,
            timePickerIncrement:    15,
            showISOWeekNumbers:     true,
            locale: {
                format: "DD/MM/YYYY",
                firstDay: 1
            },
            ranges: {
               'Yesterday':                 [moment().startOf('day').subtract(1, 'days'), moment().startOf('day').subtract(1, 'days').endOf('day')],
               'This Week to-date':         [rangeStart, rangeEnd], //default value for the page
               'Past Month':                [moment().startOf('day').subtract(1, 'months'), moment()],
               'Previous Week same range':  [moment().startOf('week').subtract(1, 'weeks'), moment().subtract(1, 'weeks')],
               'Same Week 4 Weeks ago':     [moment().startOf('week').subtract(4, 'weeks'), moment().subtract(4, 'weeks')],
               'This Month to-date':        [moment().startOf('month'), moment().endOf('month')],
               'All Time':                  ['{{current_user.primaryVenue.capture_start | date("d/m/Y", "Europe/London")}}', moment()]
            },
            startDate:  rangeStart,
            endDate:    rangeEnd,
            minDate:    '{{current_user.primaryVenue.venue_tracking.capture_start | date("d/m/Y", "Europe/London")}}',
            maxDate:    moment().startOf('day'),
            opens:      'left'
        }, page_daterange);

        /**
         * callback function to execute upon selected date range
         */
        function page_daterange(start, end) {
            $(window).trigger('resize');

            if (end.diff(start) === 0) {
                console.log('we have difference between start and end of zero: we will add 1 hour to end');
                end.add(1, 'hour');
            }

            newRangeStart = start;
            newRangeEnd   = end;

            /**
             * update the weekend plotbands
             */
            weekends = weekendAreasDaily(start, end);

            /**
             * then we need to set the charts, <div>s and <spans>s which will be refreshed, to their loading state
             */
            var chart_1_1 = $("#section_2_chart_1_1").highcharts();
            var chart_1_2 = $("#section_2_chart_1_2").highcharts();
            var chart_2_1 = $("#section_2_chart_2_1").highcharts();
            var chart_2_2 = $("#section_2_chart_2_2").highcharts();

            chart_1_1.showLoading();
            chart_1_2.showLoading();
            chart_2_1.showLoading();
            chart_2_2.showLoading();

            $('#section_2_donut_1').html('<i class="fa fa-spinner fa-spin"></i>');
            $('#section_2_donut_2').html('<i class="fa fa-spinner fa-spin"></i>');
            $('#section_2_donut_3').html('<i class="fa fa-spinner fa-spin"></i>');
            $('#section_2_donut_4').html('<i class="fa fa-spinner fa-spin"></i>');

            /**
             * place the selected range in the <span> at the top of the page
             */
            $('#section_2_page_daterange_selected_large').html('<b>' + start.format('H:mm dddd, D MMMM YYYY') + ' - ' + end.format('H:mm dddd, D MMMM YYYY') + '</b>');
            $('#section_2_page_daterange_selected_small').html('<b>' + start.format('ddd, D MMM YYYY') + ' - ' + end.format('ddd, D MMM YYYY') + '</b>');
            console.log(start + ':' + end);

            /**
             * from here we call all ajax sources with the newly selected start/end:
             */

            /**
             * get the average dwell time for donut_3
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/stats/average_dwelltime/zone/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onDonut_3_DataReceived
            });

            /**
             * get the data for donut_1, donut_4
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/visitor_report/unique_daily/zone/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onDonut_1_DataReceived
            });

            /**
             * get the data for chart 1.1, donut_2
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/zone_report/visitors_per_hourofday/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onChart_1_1_DataReceived
            });

            /**
             * get the data for chart 2.1 and 1.2
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/zone_report/new_vs_repeat/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onChart_2_1_DataReceived
            });

            /**
             * get the data for chart 2.2
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/stats/zone/visitors_durations/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onChart_2_2_DataReceived
            });
        }
        /**************************************************************
         * end of daterangepicker and ajax data loading
         **************************************************************/
    });

    /**
     * then push the received average visitor metrics to the top row donuts
     */
    function onAvgVisitorMetricsReceived(data) {
        console.log('hello');
        console.log(data);
        $('#section_2_donut_5').html(data.average_yearly.toLocaleString());
        $('#section_2_donut_6').html(data.average_monthly.toLocaleString());
        $('#section_2_donut_7').html(data.average_weekly.toLocaleString());
        $('#section_2_donut_8').html(data.average_daily.toLocaleString());
    }

    /**
     * push the received data to donut_3
     */
    function onDonut_3_DataReceived(data) {
        // Load all the data into the DOM
        $('#section_2_donut_3').html(data + ' <span style="font-size: 60%;">minutes</span>');
    }

    /**
     * push the received data to donut_4
     */
    function onDonut_1_DataReceived(data) {
        /**
         * NOTE: with this function we also feed the "total visitors" data to donut 4
         * - count length in days between first and last element in series
         * - or do we use the number of days we have data for to calculate averages?
         */
        var total_visitors = 0;
        var counter = data.length;
        _.forEach(data, function(value, key) {
            total_visitors += value[1];
        });

        if (counter > 1) {
            var average = Math.round(total_visitors/counter);
        } else {
            var average = total_visitors;
        }

        console.log('total visitors: ' + total_visitors + ' # of days we work with: ' + counter);

        $('#section_2_donut_1').html(total_visitors.toLocaleString());
        $('#section_2_donut_4').html(average.toLocaleString());
    }
    /*****************************************************************
     * end of top row donut charts
     *****************************************************************/
});
</script>

<script type="text/javascript">
$(document).ready(function() {
    /***************************************************************
     * preparations for section 3 from here
     ***************************************************************/

    /*******************************************************************
     * start of timeOfDay average: chart 1.1
     * container: chart_1_1
     * url: api/zone_report/visitors_per_hourofday/$zone_id/$start/$end
     *******************************************************************/
    var chart_1_1_Options = {
        chart: {
            renderTo: 'section_3_chart_1_1',
            backgroundColor: '#FFFFFF',
            type: 'area'
        },
        xAxis: {
            type: 'category'
        },
        tooltip: {
            shared: true,
            formatter: function () {
                var tooltipcontent = '<b>Between ' + this.x + ':00 and ' + (this.x+1) + ':00</b>';
                // we have to loop here as we don't yet know how many series we will have
                $.each(this.points, function () {
                    tooltipcontent += '<br/>' + this.series.name + ': ' +
                        this.y.toLocaleString();
                });

                return tooltipcontent;
            }
        },
        legend: {
            enabled: true
        }
    };

    function onChart_1_1_DataReceived(data) {
        /**
         * do something with the data
         */
        var seriesoptions = [
            {
                type: 'area',
                color: '#e25826', // e25826
                name: 'average visitors'
            }
        ];

        chart_1_1_Options.series = seriesoptions;
        chart_1_1 = new Highcharts.Chart(chart_1_1_Options);
        chart_1_1.series[0].setData(data);

        /**
         * here we also get the busiest hour and send that to donut 4
         */
        var hours = _.sortBy(data, function(value, key) {
            return value[1];
        });

        if (hours.length > 0) {
            $('#section_3_donut_2').html((_.last(hours)[0]) + ':00 - ' + (_.last(hours)[0] + 1) + ':00');
        } else {
            $('#section_3_donut_2').html('<span style="font-size: 60%;">no data</span>');
        }

    }
    /***************************************************************
     * end of chart 1.1
     ***************************************************************/

    /***************************************************************
     * start of new/repeat chart
     * container: chart_1_2
     ***************************************************************/
    var chart_1_2_Options = {
        chart: {
            type: 'pie',
            renderTo: 'section_3_chart_1_2',
            backgroundColor: '#FFFFFF',
            plotBorderWidth: null,
            plotShadow: false,
            spacingTop: 0,
            spacingBottom: 0,
            spacingLeft: 0,
            spacingRight: 0
        },
        plotOptions: {
            pie: {
                innerSize: '65%',
                center: ['50%', '50%'],
                borderWidth: 0,
                allowPointSelect: false,
                cursor: false,
                showInLegend: true,
                point: {
                    events: {
                        legendItemClick: function () {
                            return false;
                        }
                    }
                }
            },
            series: {
                states: {
                    hover: {
                        enabled: false
                    }
                }
            }
        },
        legend: {
            align: 'right',
            verticalAlign: 'top',
            layout: 'vertical',
            floating: true
        },
        tooltip: {
            formatter: function () {
                var tooltipcontent = '<b>' + this.key + '</b><br>' + (Math.round(this.percentage*10))/10 + '% (' + this.y.toLocaleString() + ' of ' + this.total.toLocaleString() + ')';
                return tooltipcontent;
            }
        },
        title: {
            align: 'center',
            verticalAlign: 'middle',
            y: 10
        },
        series: [{
            name: "visitors",
            data: [{
                name: "new visitors",
                y: 0,
                color: '#e25826'
            },
            {
                name: "repeat visitors",
                y: 0,
                color: '#132149'
            }]
        }]
    };

    /***************************************************************
     * end of chart 1.2
     ***************************************************************/

    /***************************************************************
     * start of visitor stats chart
     * container: chart_2_1
     ***************************************************************/
    var chart_2_1_Options = {
        chart: {
            renderTo: 'section_3_chart_2_1',
            backgroundColor: '#FFFFFF',
            zoomType: 'x'
        },
        xAxis: {
            type: 'datetime',
            plotBands: weekends,
            events: {
                /**
                 * sync charts when zoom is triggered
                 */
                afterSetExtremes: function (event) {
                    var xMin = event.min;
                    var xMax = event.max;
                    var chart_2_2 = $('#section_3_chart_2_2').highcharts();
                    var ex = chart_2_2.xAxis[0].getExtremes();
                    if (ex.min != xMin || ex.max != xMax) chart_2_2.xAxis[0].setExtremes(xMin, xMax, true, false);
                }
            }
        },
        tooltip: {
            shared: true,
            formatter: function () {
                var tooltipcontent = '<b>' + moment(this.x).format("dddd, D MMMM YYYY") + '</b>';

                /**
                 * we have to loop here as we don't yet know how many series we will have
                 */
                $.each(this.points, function () {
                    symbol = '■';
                    tooltipcontent += '<br/><span style="color:' + this.point.color + '">' + symbol + '</span> ' + this.series.name + ': ' +
                        this.y.toLocaleString();
                });

                return tooltipcontent;
            }
        },
        plotOptions: {
            column: {
                borderWidth: 0,
                stacking: 'normal'
            }
        },
        legend: {
            enabled: true
        }
    };

    /**
     * callback to be called from the bundled ajax calls
     */
    function onChart_2_1_DataReceived(data) {
        /**
         * Load all the data for the chart
         */
        if (typeof data.new == 'undefined' || data.new == null) {
            data.new = [];
        }

        if (typeof data.repeat == 'undefined' || data.repeat == null) {
            data.repeat = [];
        }

        /**
         * do something with the data
         */
        var seriesoptions = [
            {
                type: 'column', // default chart type
                lineWidth: 2,
                states: {
                    hover: {
                        enabled: true,
                        lineWidth: 2
                    }
                },
                color: '#e25826',
                name: 'new visitors',
                stack: 'visitors'
            },
            {
                type: 'column', // default chart type
                lineWidth: 2,
                states: {
                    hover: {
                        enabled: true,
                        lineWidth: 2
                    }
                },
                color: '#132149',
                name: 'repeat visitors',
                stack: 'visitors'
            }
        ];

        /**
         * when date range is longer than 5 weeks we switch to area chart instead of column
         */
        if (data.new && data.new.length > 5*7) {
            seriesoptions[0].type = 'area';
            seriesoptions[1].type = 'area';
        }

        chart_2_1_Options.yAxis = {
            stackLabels: {
                useHTML: true,
                enabled: true,
                align: 'center',
                verticalAlign: 'top',
                formatter: function () {
                    var day_epoch  = this.x;
                    var event = '';
                    var event_categories = [];
                    $.each(data.event, function(key, value) {
                        if (day_epoch >= value['start_date'] && day_epoch <= value['end_date']) {
                            if (event_categories.length == 0) {
                                event = `<span padding-top: 20px;><i style="background-color:` + value['color'] + `" class="circle-icon fa fa-calendar"></i></span>`;
                                event_categories.push(value['category_id']); 
                            }

                            if ($.inArray(value['category_id'], event_categories) == -1) {
                                event += `<br><span><i style="background-color:` + value['color'] + `" class="circle-icon fa fa-calendar fa-sm"></i></span>`;
                                event_categories.push(value['category_id']); 
                            }
                        }
                    });
                    return event;
                }
            }
        }

        chart_2_1_Options.tooltip = {
            shared: true,
            useHTML: true,
            borderWidth: 0,
            backgroundColor: "rgba(255,255,255,0)",
            shadow: false,
            formatter: function () {
                var tooltipcontent = '<b>' + moment(this.x).format("dddd, D MMMM YYYY") + '</b>';
                var mySum = 0;

                var day_epoch  = this.x;
                $.each(data.event, function(key, value) {
                    if (day_epoch >= value['start_date'] && day_epoch <= value['end_date']) {
                        tooltipcontent += '<p><b>Event: </b>' + value['name'] + '</p>';
                    }
                });

                tooltipcontent += '<table style="width:100%">';

                /**
                 * we have to loop here as we don't yet know how many series we will have
                 */
                $.each(this.points, function () {
                    var symbol = '■';
                    tooltipcontent += '<tr><td><span style="color:' + this.point.color + '">' + symbol + '</span> ' + this.series.name + ':</td><td style="text-align: right;">' + this.y.toLocaleString() + '</td></tr>';
                    mySum += this.y;
                });

                tooltipcontent += '<tr><td><b>Total:</b></td><td style="text-align: right;"><b>' + mySum.toLocaleString() + '</b><td></tr>';
                tooltipcontent += '</table>';

                return tooltipcontent;
            }
        }

        chart_2_1_Options.series = seriesoptions;
        var chart_2_1 = new Highcharts.Chart(chart_2_1_Options);
        chart_2_1.series[0].setData(noGapsDataArray(data.new, 86400));
        chart_2_1.series[1].setData(noGapsDataArray(data.repeat, 86400));
        chart_2_1.xAxis[0].update({
            plotBands: weekends
        });

        /**
         * NOTE: with this function we also feed the "total visitors" data to chart 1.2
         */
        var totalnew = 0;
        _.forEach(data.new, function(value) {
            totalnew += value[1];
        });

        var totalrepeat = 0;
        _.forEach(data.repeat, function(value) {
            totalrepeat += value[1];
        });

        /**
         * define font size percentage for the donut contents, reduce size if total is over 1M
         */
        var chart_1_2__font_size_perc = 150;
        if (totalnew + totalrepeat >= 1000000) {
            var chart_1_2__font_size_perc = 120;
        }

        chart_1_2_Options.title.text = '<b style="font-size: ' + chart_1_2__font_size_perc + '%; font-weight: bold;">' + (totalnew + totalrepeat).toLocaleString() + '</b><br><b>Total</b>';
        var chart_1_2 = new Highcharts.Chart(chart_1_2_Options);
        chart_1_2.series[0].setData([totalnew, totalrepeat]);
    }

    /**************************************************************
     * end of chart 2.1
     **************************************************************/

    /***************************************************************
     * start of dwell time analysis chart
     * container: section_3_chart_2_2
     * plotbands: weekends
     * sync with: section_3_chart_2_1
     ***************************************************************/
    var chart_2_2_Options = $.extend(true, {}, dwell_time_analysis_options);
    chart_2_2_Options.chart.renderTo = 'section_3_chart_2_2';
    chart_2_2_Options.xAxis.plotBands = weekends;
    chart_2_2_Options.chart.zoomType = 'x';
    chart_2_2_Options.xAxis.events = {
        /**
         * sync charts when zoom is triggered
         */
        afterSetExtremes: function (event) {
            var xMin = event.min;
            var xMax = event.max;
            var chart_2_1 = $('#section_3_chart_2_1').highcharts();
            var ex = chart_2_1.xAxis[0].getExtremes();
            if (ex.min != xMin || ex.max != xMax) chart_2_1.xAxis[0].setExtremes(xMin, xMax, true, false);
        }
    };

    /**
     * callback to be called from the bundled ajax calls
     */
    function onChart_2_2_DataReceived(data) {
        /**
         * define the series received
         */
        var seriesoptions = [
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_skipped_label}}',
                visible: false,
                color: '#DD686E' // otherwise this becomes purple ;-)
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_1_label}}'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_2_label}}'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_3_label}}'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_4_label}}'
            },
            {
                type: 'area',
                name: '{{current_user.primaryVenue.dt_level_5_label}}'
            },
            {
                type: 'line',
                name: 'average dwelltime',
                yAxis: 1,
                color: '#C6D4FC',
                dashStyle: 'LongDash'
            }
        ];

        /**
         * if our date range is longer than 2 days, we disable the markers for clean lines
         * if shorter we switch to a stacked column chart
         */
        if (data['dt_level_1'].length > 2) {
            chart_2_2_Options.plotOptions.series.marker.enabled = false;
        } else {
            chart_2_2_Options.plotOptions.series.marker.enabled = true;

            $.each(seriesoptions, function () {
                if (this.type == 'area') {
                    this.type = 'column';
                }
            });
        }

        chart_2_2_Options.series = seriesoptions;
        chart_2_2 = new Highcharts.Chart(chart_2_2_Options);
        chart_2_2.series[0].setData(noGapsDataArray(data['dt_skipped'], 86400));
        chart_2_2.series[1].setData(noGapsDataArray(data['dt_level_1'], 86400));
        chart_2_2.series[2].setData(noGapsDataArray(data['dt_level_2'], 86400));
        chart_2_2.series[3].setData(noGapsDataArray(data['dt_level_3'], 86400));
        chart_2_2.series[4].setData(noGapsDataArray(data['dt_level_4'], 86400));
        chart_2_2.series[5].setData(noGapsDataArray(data['dt_level_5'], 86400));
        chart_2_2.series[6].setData(noGapsDataArray(data['dt_average'], 86400));
        chart_2_2.xAxis[0].update({
            plotBands: weekends
        });
    }

    /***************************************************************
     * end of chart 2.2
     ***************************************************************/

    /**
     * trigger on change of the <select> element:
     * - first provide feedback that the metric are going to be refreshed by spinning the metrics of the top row donuts
     * - we then get the "static" metrics (average visitors for various time units) for the top row donuts with ajax
     * - initialise all major charts
     * - initiate the ajax function to get these average visitor metrics
     * - initiate the daterangepicker to collect metrics for the default datarange
     * - allow the user to modify the daterange for selected zone
     */
    $('#section_3_select_zone_id').on('change', function() {
        /**
         * display all elements with the class for the third section
         */
        $('.zone_report_section_3').slideDown(200);

        var selected_zone_1 = this.value;

        /**
         * initialize both charts
         * first clear the data/series for the charts if they already exist
         */
        if (typeof $('#section_3_chart_1_1').highcharts() !== 'undefined') {
            $('#section_3_chart_1_1').highcharts().series[0].setData([]);
        }

        if (typeof $('#section_3_chart_1_2').highcharts() !== 'undefined') {
            $('#section_3_chart_1_2').highcharts().series[0].setData([0,0]);
        }

        if (typeof $('#section_3_chart_2_1').highcharts() !== 'undefined') {
            $('#section_3_chart_2_1').highcharts().series[0].setData([]);
            $('#section_3_chart_2_1').highcharts().series[1].setData([]);
        }

        if (typeof $('#section_3_chart_2_2').highcharts() !== 'undefined') {
            $('#section_3_chart_2_2').highcharts().series[0].setData([]);
            $('#section_3_chart_2_2').highcharts().series[1].setData([]);
            $('#section_3_chart_2_2').highcharts().series[2].setData([]);
            $('#section_3_chart_2_2').highcharts().series[3].setData([]);
            $('#section_3_chart_2_2').highcharts().series[4].setData([]);
            $('#section_3_chart_2_2').highcharts().series[5].setData([]);
        }

        var chart_1_1 = new Highcharts.Chart(chart_1_1_Options);
        var chart_1_2 = new Highcharts.Chart(chart_1_2_Options);
        var chart_2_1 = new Highcharts.Chart(chart_2_1_Options);
        var chart_2_2 = new Highcharts.Chart(chart_2_2_Options);

        chart_1_1.showLoading();
        chart_1_2.showLoading();
        chart_2_1.showLoading();
        chart_2_2.showLoading();

        /**
         * we also empty the title (centered in the donut) for chart 1.2, just make the transition smoother
         */
        chart_1_2.setTitle({ text: '' });

        /**
         * initialize the top row donuts
         */
        $('#section_3_donut_5').html('<i class="fa fa-spinner fa-spin"></i>');
        $('#section_3_donut_6').html('<i class="fa fa-spinner fa-spin"></i>');
        $('#section_3_donut_7').html('<i class="fa fa-spinner fa-spin"></i>');
        $('#section_3_donut_8').html('<i class="fa fa-spinner fa-spin"></i>');

        $.ajax({
            url:        '{{site.uri.public}}/geo-sense/api/visitor_report/alltime_averages/zone/' + selected_zone_1,
            type:       'GET',
            dataType:   'json',
            success:    onAvgVisitorMetricsReceived
        });

        /***************************************************************
         * daterangepicker and ajax loading of all the data from here
         ***************************************************************/
        /**
         * define default start and end for the page
         */
        var rangeStart = moment().startOf('day').subtract(1, 'days');
        var rangeEnd   = moment().startOf('day').subtract(1, 'days').endOf('day');

        /*
        initiate the daterangepicker with initial start/end and Label
        */
        page_daterange(rangeStart, rangeEnd);

        /**
         * functions to display the "active" custom date range and the picker for current page
         */
        $('#section_3_page_daterange').daterangepicker({
            timePicker:             true,
            timePicker24Hour:       true,
            timePickerIncrement:    15,
            showISOWeekNumbers:     true,
            locale: {
                format: "DD/MM/YYYY",
                firstDay: 1
            },
            ranges: {
               'Yesterday':                 [moment().startOf('day').subtract(1, 'days'), moment().startOf('day').subtract(1, 'days').endOf('day')],
               'This Week to-date':         [rangeStart, rangeEnd], //default value for the page
               'Past Month':                [moment().startOf('day').subtract(1, 'months'), moment()],
               'Previous Week same range':  [moment().startOf('week').subtract(1, 'weeks'), moment().subtract(1, 'weeks')],
               'Same Week 4 Weeks ago':     [moment().startOf('week').subtract(4, 'weeks'), moment().subtract(4, 'weeks')],
               'This Month to-date':        [moment().startOf('month'), moment().endOf('month')],
               'All Time':                  ['{{current_user.primaryVenue.capture_start | date("d/m/Y", "Europe/London")}}', moment()]
            },
            startDate:  rangeStart,
            endDate:    rangeEnd,
            minDate:    '{{current_user.primaryVenue.venue_tracking.capture_start | date("d/m/Y", "Europe/London")}}',
            maxDate:    moment().startOf('day'),
            opens:      'left'
        }, page_daterange);

        /**
         * callback function to execute upon selected date range
         */
        function page_daterange(start, end) {
            $(window).trigger('resize');

            if (end.diff(start) === 0) {
                console.log('we have difference between start and end of zero: we will add 1 hour to end');
                end.add(1, 'hour');
            }

            newRangeStart = start;
            newRangeEnd   = end;

            /**
             * update the weekend plotbands
             */
            weekends = weekendAreasDaily(start, end);

            /**
             * then we need to set the charts, <div>s and <spans>s which will be refreshed, to their loading state
             */
            var chart_1_1 = $("#section_3_chart_1_1").highcharts();
            var chart_1_2 = $("#section_3_chart_1_2").highcharts();
            var chart_2_1 = $("#section_3_chart_2_1").highcharts();
            var chart_2_2 = $("#section_3_chart_2_2").highcharts();

            chart_1_1.showLoading();
            chart_1_2.showLoading();
            chart_2_1.showLoading();
            chart_2_2.showLoading();

            $('#section_3_donut_1').html('<i class="fa fa-spinner fa-spin"></i>');
            $('#section_3_donut_2').html('<i class="fa fa-spinner fa-spin"></i>');
            $('#section_3_donut_3').html('<i class="fa fa-spinner fa-spin"></i>');
            $('#section_3_donut_4').html('<i class="fa fa-spinner fa-spin"></i>');

            /**
             * place the selected range in the <span> at the top of the page
             */
            $('#section_3_page_daterange_selected_large').html('<b>' + start.format('H:mm dddd, D MMMM YYYY') + ' - ' + end.format('H:mm dddd, D MMMM YYYY') + '</b>');
            $('#section_3_page_daterange_selected_small').html('<b>' + start.format('ddd, D MMM YYYY') + ' - ' + end.format('ddd, D MMM YYYY') + '</b>');
            console.log(start + ':' + end);

            /**
             * from here we call all ajax sources with the newly selected start/end:
             */

            /**
             * get the average dwell time for donut_3
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/stats/average_dwelltime/zone/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onDonut_3_DataReceived
            });

            /**
             * get the data for donut_1, donut_4
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/visitor_report/unique_daily/zone/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onDonut_1_DataReceived
            });

            /**
             * get the data for chart 1.1, donut_2
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/zone_report/visitors_per_hourofday/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onChart_1_1_DataReceived
            });

            /**
             * get the data for chart 2.1 and 1.2
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/zone_report/new_vs_repeat/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onChart_2_1_DataReceived
            });

            /**
             * get the data for chart 2.2
             */
            $.ajax({
                url:        '{{site.uri.public}}/geo-sense/api/stats/zone/visitors_durations/' + selected_zone_1 + '/' + start + '/' + end,
                type:       'GET',
                dataType:   'json',
                success:    onChart_2_2_DataReceived
            });
        }
        /**************************************************************
         * end of daterangepicker and ajax data loading
         **************************************************************/
    });

    /**
     * then push the received average visitor metrics to the top row donuts
     */
    function onAvgVisitorMetricsReceived(data) {
        $('#section_3_donut_5').html(data.average_yearly.toLocaleString());
        $('#section_3_donut_6').html(data.average_monthly.toLocaleString());
        $('#section_3_donut_7').html(data.average_weekly.toLocaleString());
        $('#section_3_donut_8').html(data.average_daily.toLocaleString());
    }

    /**
     * push the received data to donut_3
     */
    function onDonut_3_DataReceived(data) {
        // Load all the data into the DOM
        $('#section_3_donut_3').html(data + ' <span style="font-size: 60%;">minutes</span>');
    }

    /**
     * push the received data to donut_4
     */
    function onDonut_1_DataReceived(data) {
        /**
         * NOTE: with this function we also feed the "total visitors" data to donut 4
         * - count length in days between first and last element in series
         * - or do we use the number of days we have data for to calculate averages?
         */
        var total_visitors = 0;
        var counter = data.length;
        _.forEach(data, function(value, key) {
            total_visitors += value[1];
        });

        if (counter > 1) {
            var average = Math.round(total_visitors/counter);
        } else {
            var average = total_visitors;
        }

        console.log('total visitors: ' + total_visitors + ' # of days we work with: ' + counter);

        $('#section_3_donut_1').html(total_visitors.toLocaleString());
        $('#section_3_donut_4').html(average.toLocaleString());
    }
    /*****************************************************************
     * end of top row donut charts
     *****************************************************************/
});
</script>
{% endblock %}